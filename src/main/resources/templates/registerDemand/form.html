<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <title>需要予測登録</title>
  <style>
    .time-input-table {
      font-size: 0.95rem;
    }
    .time-input-table th {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      font-weight: 600;
      text-align: center;
      vertical-align: middle;
    }
    .time-input-table td {
      vertical-align: middle;
    }
    .time-cell {
      background: #f8f9fa;
      font-weight: 500;
      color: #495057;
      width: 120px;
    }
    .demand-input {
      width: 100px;
      text-align: center;
    }
    .demand-input:focus {
      border-color: #86b7fe;
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    .summary-stats {
      background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
      border-radius: 8px;
      padding: 1rem;
    }
    .quick-fill-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .quick-fill-btn {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
    }
  </style>
</head>
<body>
<div layout:fragment="content">
  <div class="content-header">
    <h1><i class="bi bi-bar-chart"></i> 需要予測登録</h1>
    <p class="mb-0">時間帯別の必要レジスター台数を設定できます</p>
  </div>

  <!-- 検索条件カード -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-calendar-date"></i> 日付選択</h5>
    </div>
    <div class="card-body">
      <form method="get" th:action="@{/register-demand}">
        <div class="row align-items-end">
          <div class="col-md-4">
            <label for="date" class="form-label">
              <i class="bi bi-calendar3"></i> 対象日
            </label>
            <input id="date" 
                   name="date" 
                   type="date"
                   class="form-control"
                   th:value="${#temporals.format(command?.targetDate, 'yyyy-MM-dd')}"
                   required/>
          </div>
          <div class="col-md-4">
            <label class="form-label">
              <i class="bi bi-shop"></i> 店舗
            </label>
            <div class="form-control-plaintext">
              <span class="badge bg-info">569 - テスト店舗</span>
            </div>
          </div>
          <div class="col-md-4">
            <button class="btn btn-primary" type="submit">
              <i class="bi bi-search"></i> 検索
            </button>
            <button class="btn btn-outline-secondary ms-2" type="button" onclick="document.getElementById('date').valueAsDate = new Date();">
              <i class="bi bi-calendar-check"></i> 今日
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- 需要入力フォーム -->
  <div th:if="${command != null}">
    <div class="row">
      <div class="col-lg-8">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="bi bi-clock"></i> 
              時間帯別需要設定
              <small class="text-muted">
                (<span th:text="${#temporals.format(command.targetDate, 'yyyy年M月d日')}"></span>)
              </small>
            </h5>
            <div class="quick-fill-buttons">
              <button type="button" class="btn btn-outline-primary quick-fill-btn" onclick="fillAll(0)">
                <i class="bi bi-x-circle"></i> 全て0
              </button>
              <button type="button" class="btn btn-outline-primary quick-fill-btn" onclick="fillAll(1)">
                <i class="bi bi-1-square"></i> 全て1
              </button>
              <button type="button" class="btn btn-outline-primary quick-fill-btn" onclick="fillAll(2)">
                <i class="bi bi-2-square"></i> 全て2
              </button>
              <button type="button" class="btn btn-outline-primary quick-fill-btn" onclick="fillWorkingHours()">
                <i class="bi bi-clock-history"></i> 営業時間
              </button>
            </div>
          </div>
          <div class="card-body p-0">
            <form th:action="@{/register-demand}" th:object="${command}" method="post">
              <input type="hidden" th:field="*{storeCode}"/>
              <input type="hidden" th:field="*{targetDate}"/>

              <div class="table-responsive">
                <table class="table time-input-table mb-0">
                  <thead>
                    <tr>
                      <th scope="col" style="width: 120px;">
                        <i class="bi bi-clock"></i> 時間帯
                      </th>
                      <th scope="col" style="width: 150px;">
                        <i class="bi bi-calculator"></i> 必要台数
                      </th>
                      <th scope="col">
                        <i class="bi bi-info-circle"></i> 備考
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:each="hour,stat : *{hours}">
                      <td class="time-cell text-center">
                        <strong th:text="${#numbers.formatInteger(hour.hour.hour,2)} + ':00 - ' + ${#numbers.formatInteger(hour.hour.hour + 1,2)} + ':00'"></strong>
                      </td>

                      <input type="hidden"
                             th:field="*{hours[__${stat.index}__].hour}"
                             th:value="${#temporals.format(hour.hour,'HH:mm')}" />

                      <td class="text-center">
                        <div class="input-group input-group-sm justify-content-center">
                          <button type="button" class="btn btn-outline-secondary" onclick="changeValue(this, -1)">
                            <i class="bi bi-dash"></i>
                          </button>
                          <input type="number" 
                                 min="0" 
                                 max="10" 
                                 step="1" 
                                 class="form-control demand-input"
                                 th:field="*{hours[__${stat.index}__].requiredUnits}"
                                 th:value="${hour.requiredUnits}"
                                 onchange="updateSummary()"/>
                          <button type="button" class="btn btn-outline-secondary" onclick="changeValue(this, 1)">
                            <i class="bi bi-plus"></i>
                          </button>
                        </div>
                      </td>
                      <td class="small text-muted">
                        <span th:if="${hour.hour.hour >= 8 && hour.hour.hour < 22}" class="text-primary">
                          <i class="bi bi-shop"></i> 営業時間
                        </span>
                        <span th:if="${hour.hour.hour < 8 || hour.hour.hour >= 22}" class="text-secondary">
                          <i class="bi bi-moon"></i> 営業時間外
                        </span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="p-3 border-top bg-light d-flex justify-content-between align-items-center">
                <div class="text-muted small">
                  <i class="bi bi-lightbulb"></i>
                  ヒント: +/-ボタンまたは直接入力で台数を設定できます
                </div>
                <button class="btn btn-success" type="submit">
                  <i class="bi bi-check-lg"></i> 需要予測を保存
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-bar-chart-line"></i> 需要サマリー</h6>
          </div>
          <div class="card-body">
            <div class="summary-stats mb-3">
              <div class="row text-center">
                <div class="col-4">
                  <div class="h4 mb-1 text-primary" id="totalDemand">0</div>
                  <div class="small text-muted">総需要</div>
                </div>
                <div class="col-4">
                  <div class="h4 mb-1 text-success" id="peakDemand">0</div>
                  <div class="small text-muted">ピーク</div>
                </div>
                <div class="col-4">
                  <div class="h4 mb-1 text-info" id="averageDemand">0.0</div>
                  <div class="small text-muted">平均</div>
                </div>
              </div>
            </div>
            
            <div id="demandChart" class="mb-3">
              <!-- 簡易チャート表示エリア -->
              <div class="small text-muted mb-2">時間帯別需要グラフ</div>
              <div id="chartBars" class="d-flex align-items-end justify-content-between" style="height: 100px;">
                <!-- JavaScriptで動的生成 -->
              </div>
            </div>
          </div>
        </div>

        <div class="card mt-3">
          <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-info-circle"></i> 入力ガイド</h6>
          </div>
          <div class="card-body">
            <ul class="small list-unstyled">
              <li class="mb-2">
                <i class="bi bi-check-circle text-success"></i>
                各時間帯に必要なレジスター台数を設定
              </li>
              <li class="mb-2">
                <i class="bi bi-check-circle text-success"></i>
                営業時間（8:00-22:00）は通常1台以上設定
              </li>
              <li class="mb-2">
                <i class="bi bi-check-circle text-success"></i>
                ピーク時間帯は需要を多めに設定
              </li>
              <li>
                <i class="bi bi-check-circle text-success"></i>
                設定後は必ず保存ボタンをクリック
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div th:if="${command == null}" class="card">
    <div class="card-body text-center py-5">
      <i class="bi bi-calendar-plus display-1 text-muted"></i>
      <h4 class="text-muted mt-3">日付を選択してください</h4>
      <p class="text-muted">上記の日付選択フィールドから対象日を選んで「検索」ボタンをクリックしてください。</p>
    </div>
  </div>

  <script>
    function changeValue(button, change) {
      const input = button.parentElement.querySelector('input[type="number"]');
      const currentValue = parseInt(input.value) || 0;
      const newValue = Math.max(0, Math.min(10, currentValue + change));
      input.value = newValue;
      updateSummary();
    }

    function fillAll(value) {
      const inputs = document.querySelectorAll('.demand-input');
      inputs.forEach(input => {
        input.value = value;
      });
      updateSummary();
    }

    function fillWorkingHours() {
      const inputs = document.querySelectorAll('.demand-input');
      inputs.forEach((input, index) => {
        // 8:00-22:00 (index 8-21) に1を設定、それ以外は0
        input.value = (index >= 8 && index < 22) ? 1 : 0;
      });
      updateSummary();
    }

    function updateSummary() {
      const inputs = document.querySelectorAll('.demand-input');
      let total = 0;
      let peak = 0;
      const values = [];

      inputs.forEach(input => {
        const value = parseInt(input.value) || 0;
        values.push(value);
        total += value;
        peak = Math.max(peak, value);
      });

      const average = values.length > 0 ? (total / values.length).toFixed(1) : '0.0';

      document.getElementById('totalDemand').textContent = total;
      document.getElementById('peakDemand').textContent = peak;
      document.getElementById('averageDemand').textContent = average;

      // 簡易チャート更新
      updateChart(values);
    }

    function updateChart(values) {
      const chartBars = document.getElementById('chartBars');
      chartBars.innerHTML = '';
      const maxValue = Math.max(...values, 1);

      values.forEach((value, index) => {
        const bar = document.createElement('div');
        const height = (value / maxValue) * 80; // 最大80px
        bar.style.cssText = `
          width: 3px;
          height: ${height}px;
          background: linear-gradient(to top, #667eea, #764ba2);
          border-radius: 2px;
          position: relative;
        `;
        
        if (value > 0) {
          bar.title = `${index}:00 - ${value}台`;
        }
        
        chartBars.appendChild(bar);
      });
    }

    // ページ読み込み時にサマリーを初期化
    document.addEventListener('DOMContentLoaded', function() {
      updateSummary();
    });
  </script>
</div>
</body>
</html>