<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}">
<head>
  <meta charset="UTF-8">
  <title>レジマスタ</title>
</head>
<body>
<main layout:fragment="content">
  <div th:replace="~{fragments/master-layout :: master-list-modal('レジマスタ', 'bi bi-cash-register', ~{::add-modal}, ~{::data-table}, ~{::edit-modal})}">
    
    <!-- Data Table -->
    <div th:fragment="data-table" class="table-responsive">
      <table class="table table-sm">
        <thead>
          <tr>
            <th>店舗</th>
            <th>No</th>
            <th>名称</th>
            <th>タイプ</th>
            <th>自動開店</th>
            <th>優先</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="r : ${list}">
            <td th:text="${r.storeCode}"></td>
            <td th:text="${r.registerNo}"></td>
            <td th:text="${r.registerName}"></td>
            <td th:text="${r.registerType}"></td>
            <td><span th:text="${r.isAutoOpenTarget} ? '○' : '-'"></span></td>
            <td th:text="${r.openPriority}"></td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1 edit-btn"
                      th:data-store-code="${r.storeCode}"
                      th:data-register-no="${r.registerNo}"
                      th:data-register-name="${r.registerName}"
                      th:data-short-name="${r.shortName}"
                      th:data-open-priority="${r.openPriority}"
                      th:data-register-type="${r.registerType}"
                      th:data-is-auto-open-target="${r.isAutoOpenTarget}"
                      th:data-max-allowance="${r.maxAllowance}">編集</button>
              <form th:action="@{'/masters/register/' + ${r.storeCode} + '/' + ${r.registerNo} + '/delete'}" method="post" class="d-inline" onsubmit="return confirm('このレジを削除しますか？');">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                <button class="btn btn-sm btn-outline-danger">削除</button>
              </form>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Add Modal -->
    <div th:fragment="add-modal" class="modal fade" id="addModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">レジ追加</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form th:action="@{/masters/register}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <div class="modal-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">店舗コード</label>
                    <input type="text" class="form-control" name="storeCode" required maxlength="32">
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">レジ番号</label>
                    <input type="number" class="form-control" name="registerNo" required>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">レジ名</label>
                    <input type="text" class="form-control" name="registerName" maxlength="100">
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">略称</label>
                    <input type="text" class="form-control" name="shortName" maxlength="50">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-4">
                  <div class="mb-3">
                    <label class="form-label">開店優先</label>
                    <input type="number" class="form-control" name="openPriority">
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="mb-3">
                    <label class="form-label">タイプ</label>
                    <select class="form-control" name="registerType">
                      <option value="NORMAL">NORMAL</option>
                      <option value="SEMI">SEMI</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="mb-3">
                    <label class="form-label">最大許容(分)</label>
                    <input type="number" class="form-control" name="maxAllowance">
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="isAutoOpenTarget" id="addIsAutoOpenTarget">
                  <label class="form-check-label" for="addIsAutoOpenTarget">自動開店対象</label>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
              <button type="submit" class="btn btn-primary">追加</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div th:fragment="edit-modal" class="modal fade" id="editModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">レジ編集</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form id="editForm" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <div class="modal-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">店舗コード</label>
                    <input type="text" class="form-control" id="editStoreCode" readonly>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">レジ番号</label>
                    <input type="number" class="form-control" id="editRegisterNo" readonly>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">レジ名</label>
                    <input type="text" class="form-control" name="registerName" id="editRegisterName" maxlength="100">
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">略称</label>
                    <input type="text" class="form-control" name="shortName" id="editShortName" maxlength="50">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-4">
                  <div class="mb-3">
                    <label class="form-label">開店優先</label>
                    <input type="number" class="form-control" name="openPriority" id="editOpenPriority">
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="mb-3">
                    <label class="form-label">タイプ</label>
                    <select class="form-control" name="registerType" id="editRegisterType">
                      <option value="NORMAL">NORMAL</option>
                      <option value="SEMI">SEMI</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="mb-3">
                    <label class="form-label">最大許容(分)</label>
                    <input type="number" class="form-control" name="maxAllowance" id="editMaxAllowance">
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="isAutoOpenTarget" id="editIsAutoOpenTarget">
                  <label class="form-check-label" for="editIsAutoOpenTarget">自動開店対象</label>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
              <button type="submit" class="btn btn-primary">更新</button>
            </div>
          </form>
        </div>
      </div>
    </div>

  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const storeCode = this.getAttribute('data-store-code');
          const registerNo = this.getAttribute('data-register-no');
          const registerName = this.getAttribute('data-register-name');
          const shortName = this.getAttribute('data-short-name');
          const openPriority = this.getAttribute('data-open-priority');
          const registerType = this.getAttribute('data-register-type');
          const isAutoOpenTarget = this.getAttribute('data-is-auto-open-target') === 'true';
          const maxAllowance = this.getAttribute('data-max-allowance');
          
          document.getElementById('editStoreCode').value = storeCode;
          document.getElementById('editRegisterNo').value = registerNo;
          document.getElementById('editRegisterName').value = registerName || '';
          document.getElementById('editShortName').value = shortName || '';
          document.getElementById('editOpenPriority').value = openPriority || '';
          document.getElementById('editRegisterType').value = registerType || 'NORMAL';
          document.getElementById('editIsAutoOpenTarget').checked = isAutoOpenTarget;
          document.getElementById('editMaxAllowance').value = maxAllowance || '';
          
          document.getElementById('editForm').action = '/masters/register/' + storeCode + '/' + registerNo + '/update';
          
          new bootstrap.Modal(document.getElementById('editModal')).show();
        });
      });
    });
  </script>
</main>
</body>
</html>