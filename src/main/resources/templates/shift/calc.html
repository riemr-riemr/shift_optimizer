<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <title>日次シフト表示</title>
</head>
<body>
<div layout:fragment="content">
  <div class="content-header">
    <h1><i class="bi bi-calendar-day"></i> 日次シフト表示</h1>
    <p class="mb-0">日別のシフト割り当て結果を確認できます</p>
  </div>

<div class="row g-4">
  <!-- Control Panel -->
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-sliders"></i> 表示設定</h5>
      </div>
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label fw-semibold">
              <i class="bi bi-calendar-day me-1"></i>表示日
            </label>
            <input type="date" id="date" class="form-control form-control-lg">
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">
              <i class="bi bi-shop me-1"></i>店舗
            </label>
            <select id="storeCode" class="form-select form-select-lg">
              <option value="569">569 - テスト店舗</option>
            </select>
          </div>
          <div class="col-md-3">
            <div class="btn-group w-100" role="group">
              <button id="btnPrevDay" class="btn btn-outline-secondary">
                <i class="bi bi-chevron-left"></i> 前日
              </button>
              <button id="btnSearch" class="btn btn-primary">
                <i class="bi bi-search"></i> 検索
              </button>
              <button id="btnNextDay" class="btn btn-outline-secondary">
                翌日 <i class="bi bi-chevron-right"></i>
              </button>
            </div>
          </div>
          <div class="col-md-3">
            <button id="btnToday" class="btn btn-success w-100">
              <i class="bi bi-calendar-today"></i> 今日
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Work Model Section -->
<div class="row g-4 mt-2">
  <div class="col-12">
    <div class="card" id="workModelCard" style="display: none;">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="bi bi-bar-chart me-2"></i>作業モデル（必要レジ台数）
        </h5>
        <button type="button" id="scrollSyncBtn" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-arrow-down-up"></i> スクロール同期: ON
        </button>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive" id="workModelContainer" style="max-height: 400px; overflow-x: auto; overflow-y: auto;">
          <div id="workModelGrid" class="shift-grid-container"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Results Section -->
<div class="row g-4 mt-2">
  <div class="col-12">
    <div class="card" id="resultsCard">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="bi bi-table me-2"></i>シフト割り当て結果
        </h5>
        <div class="text-muted small" id="displayDate">
          表示日を選択してください
        </div>
      </div>
      <div class="card-body p-0">
        <div id="noDataMessage" class="text-center py-5 text-muted">
          <i class="bi bi-calendar-x display-4 d-block mb-3"></i>
          <h6>シフトデータがありません</h6>
          <p class="mb-0">日付を選択して検索ボタンを押してください</p>
        </div>
        <div class="table-responsive" style="max-height: 600px; overflow-x: auto; overflow-y: auto; display: none;" id="tableContainer">
          <div id="shiftGrid" class="shift-grid-container"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .shift-grid-container {
    display: grid;
    grid-template-columns: 120px repeat(96, 50px);
    gap: 1px;
    border: 1px solid #dee2e6;
    min-width: 4920px; /* 120px + (96 * 50px) + gaps */
    width: max-content;
  }
  
  .grid-header, .grid-cell {
    padding: 8px 4px;
    text-align: center;
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    white-space: nowrap;
    font-size: 0.75rem;
  }
  
  .grid-header.time-slot {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 1;
  }
  
  .grid-row-header {
    font-weight: 700;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    position: sticky;
    left: 0;
    z-index: 1;
  }
  
  .grid-cell.assigned {
    font-weight: 600;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
  }
  
  .grid-cell.assigned.color-0 { background: linear-gradient(135deg, #28a745, #20c997); }
  .grid-cell.assigned.color-1 { background: linear-gradient(135deg, #007bff, #6610f2); }
  .grid-cell.assigned.color-2 { background: linear-gradient(135deg, #ffc107, #fd7e14); }
  .grid-cell.assigned.color-3 { background: linear-gradient(135deg, #dc3545, #e83e8c); }
  .grid-cell.assigned.color-4 { background: linear-gradient(135deg, #6c757d, #495057); }
  
  .employee-shift-cell {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    font-size: 0.7rem;
    font-weight: 600;
  }
  
  .employee-name {
    font-size: 0.8rem;
    font-weight: 600;
    color: white;
    line-height: 1.2;
  }
  
  .employee-code {
    font-size: 0.7rem;
    color: rgba(255,255,255,0.8);
    margin-top: 2px;
  }
  
  .work-model-cell {
    position: relative;
    padding: 2px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 600;
    border: 1px solid #dee2e6;
  }
  
  .work-model-cell.register-needed {
    background: linear-gradient(135deg, #28a745, #20c997);
    border: 1px solid #1e7e34;
  }
  
  .work-model-cell-empty {
    background: transparent;
    border: none;
    height: 35px;
  }
  
  #scrollSyncBtn {
    transition: all 0.3s ease;
  }
  
  #scrollSyncBtn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
</style>

<script>
const $=id=>document.getElementById(id);

// Function to generate a consistent color based on employee name
function getEmployeeColorClass(employeeName) {
  let hash = 0;
  for (let i = 0; i < employeeName.length; i++) {
    hash = employeeName.charCodeAt(i) + ((hash << 5) - hash);
  }
  return `color-${Math.abs(hash) % 5}`; // Use 5 distinct colors
}

// 今日ボタンの処理
$('btnToday').onclick=()=>{
  const today = new Date().toISOString().split('T')[0];
  $('date').value = today;
  loadResult(today);
};

// スクロール同期機能
let scrollSyncEnabled = true;
let isScrolling = false;

function setupScrollSync() {
  const workModelContainer = $('workModelContainer');
  const shiftContainer = $('tableContainer');
  const syncBtn = $('scrollSyncBtn');
  
  if (!workModelContainer || !shiftContainer || !syncBtn) return;
  
  // スクロール同期/解除ボタンのイベント
  syncBtn.onclick = () => {
    scrollSyncEnabled = !scrollSyncEnabled;
    syncBtn.innerHTML = scrollSyncEnabled ? 
      '<i class="bi bi-arrow-down-up"></i> スクロール同期: ON' : 
      '<i class="bi bi-arrow-down-up"></i> スクロール同期: OFF';
    syncBtn.className = scrollSyncEnabled ? 
      'btn btn-outline-primary btn-sm' : 
      'btn btn-outline-secondary btn-sm';
  };
  
  // 作業モデルのスクロールイベント
  workModelContainer.addEventListener('scroll', function() {
    if (!scrollSyncEnabled || isScrolling) return;
    isScrolling = true;
    
    shiftContainer.scrollLeft = this.scrollLeft;
    
    setTimeout(() => { isScrolling = false; }, 50);
  });
  
  // シフト割り当てのスクロールイベント
  shiftContainer.addEventListener('scroll', function() {
    if (!scrollSyncEnabled || isScrolling) return;
    isScrolling = true;
    
    workModelContainer.scrollLeft = this.scrollLeft;
    
    setTimeout(() => { isScrolling = false; }, 50);
  });
}

$('btnSearch').onclick=async()=>{
  const d=$('date').value;
  if(!d){alert('日付を選択してください');return;}
  loadResult(d);
};

$('btnPrevDay').onclick=()=>{
  const currentDate = $('date').value;
  if(!currentDate){
    alert('日付を選択してください');
    return;
  }
  const date = new Date(currentDate);
  date.setDate(date.getDate() - 1);
  const newDate = date.toISOString().split('T')[0];
  $('date').value = newDate;
  loadResult(newDate);
};

$('btnNextDay').onclick=()=>{
  const currentDate = $('date').value;
  if(!currentDate){
    alert('日付を選択してください');
    return;
  }
  const date = new Date(currentDate);
  date.setDate(date.getDate() + 1);
  const newDate = date.toISOString().split('T')[0];
  $('date').value = newDate;
  loadResult(newDate);
};

async function loadResult(dateString){
  let data;
  let employees;
  
  try {
    // 表示日付を更新
    const displayDate = new Date(dateString);
    const formattedDate = displayDate.toLocaleDateString('ja-JP', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric', 
      weekday: 'long' 
    });
    $('displayDate').textContent = formattedDate;
    
    const storeCode = $('storeCode').value;
    
    // 並行してデータを取得
    const [shiftData, employeeData] = await Promise.all([
      fetch(`/shift/api/calc/assignments/daily/${dateString}`).then(r=>r.json()),
      fetch(`/shift/api/calc/employees/${storeCode}`).then(r=>r.json())
    ]);
    
    data = shiftData;
    employees = employeeData;
    
    const shiftGrid = $('shiftGrid');
    const noDataMessage = $('noDataMessage');
    const tableContainer = $('tableContainer');
    
    shiftGrid.innerHTML = ''; // Clear previous content
    
    if (employees && employees.length > 0) {
      noDataMessage.style.display = 'none';
      tableContainer.style.display = 'block';
      
      // 作業モデルデータも同時に取得・表示
      loadWorkModel(dateString);
    } else {
      noDataMessage.style.display = 'block';
      tableContainer.style.display = 'none';
      $('workModelCard').style.display = 'none';
      return;
    }
  } catch (error) {
    console.error('データ取得エラー:', error);
    $('noDataMessage').style.display = 'block';
    $('tableContainer').style.display = 'none';
    $('workModelCard').style.display = 'none';
    return;
  }

  // 15分間隔の時間ヘッダーを作成
  const timeHeaderRow = document.createElement('div');
  timeHeaderRow.className = 'grid-row';
  timeHeaderRow.style.gridColumn = '1 / -1';
  timeHeaderRow.style.display = 'contents';

  const emptyHeader = document.createElement('div');
  emptyHeader.className = 'grid-header';
  emptyHeader.textContent = '従業員';
  timeHeaderRow.appendChild(emptyHeader);

  for (let h = 0; h < 24; h++) {
    for (let m = 0; m < 60; m += 15) {
      const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
      const timeHeader = document.createElement('div');
      timeHeader.className = 'grid-header time-slot';
      timeHeader.textContent = time;
      timeHeaderRow.appendChild(timeHeader);
    }
  }
  shiftGrid.appendChild(timeHeaderRow);

  // 従業員ごとの行を作成
  employees.forEach(employee => {
    const employeeRowHeader = document.createElement('div');
    employeeRowHeader.className = 'grid-row-header';
    employeeRowHeader.innerHTML = `
      <div class="employee-name">${employee.employeeName}</div>
      <div class="employee-code">${employee.employeeCode}</div>
    `;
    shiftGrid.appendChild(employeeRowHeader);

    for (let h = 0; h < 24; h++) {
      for (let m = 0; m < 60; m += 15) {
        const cell = document.createElement('div');
        cell.className = 'grid-cell employee-shift-cell';
        cell.dataset.employee = employee.employeeCode;
        cell.dataset.time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        shiftGrid.appendChild(cell);
      }
    }
  });

  // シフト割り当てデータでセルを塗りつぶし
  if (data && data.length > 0) {
    data.forEach(assignment => {
      const start = new Date(assignment.startAt);
      const end = new Date(assignment.endAt);
      const colorClass = getEmployeeColorClass(assignment.employeeName);

      // 15分間隔でセルを塗りつぶし
      let currentTime = new Date(start);
      while (currentTime < end) {
        const hour = currentTime.getHours();
        const minute = currentTime.getMinutes();
        const targetTime = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;

        const cell = shiftGrid.querySelector(`.grid-cell[data-employee="${assignment.employeeCode}"][data-time="${targetTime}"]`);
        if (cell) {
          cell.classList.add('assigned', colorClass);
          cell.textContent = `R${assignment.registerNo}`;
        }
        currentTime.setMinutes(currentTime.getMinutes() + 15);
      }
    });
  }
  
  // スクロール同期をセットアップ
  setupScrollSync();
}

async function loadWorkModel(dateString) {
  try {
    const workModelData = await fetch(`/shift/api/calc/work-model-quarter/${dateString}`).then(r => r.json());
    const workModelGrid = $('workModelGrid');
    const workModelCard = $('workModelCard');
    
    workModelGrid.innerHTML = ''; // Clear previous content
    console.log('Work model data:', workModelData); // デバッグ用
    
    if (workModelData && workModelData.length > 0) {
      workModelCard.style.display = 'block';
      
      // 15分間隔の時間ヘッダーを作成（シフト表示と同じ）
      const timeHeaderRow = document.createElement('div');
      timeHeaderRow.className = 'grid-row';
      timeHeaderRow.style.gridColumn = '1 / -1';
      timeHeaderRow.style.display = 'contents';

      const emptyHeader = document.createElement('div');
      emptyHeader.className = 'grid-header';
      emptyHeader.textContent = '時間';
      timeHeaderRow.appendChild(emptyHeader);

      for (let h = 0; h < 24; h++) {
        for (let m = 0; m < 60; m += 15) {
          const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
          const timeHeader = document.createElement('div');
          timeHeader.className = 'grid-header time-slot';
          timeHeader.textContent = time;
          timeHeaderRow.appendChild(timeHeader);
        }
      }
      workModelGrid.appendChild(timeHeaderRow);

      // 最大レジ台数を計算
      const maxDemand = Math.max(...workModelData.map(d => d.requiredUnits || 0), 1);
      
      // 各時間帯での需要データを事前に処理
      const demandByTime = new Map();
      for (let h = 0; h < 24; h++) {
        for (let m = 0; m < 60; m += 15) {
          const targetTime = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:00`;
          const quarterData = workModelData.find(d => {
            if (!d.slotTime) return false;
            const timeStr = typeof d.slotTime === 'string' ? d.slotTime : 
                           (d.slotTime.hour !== undefined ? 
                            `${String(d.slotTime.hour).padStart(2, '0')}:${String(d.slotTime.minute).padStart(2, '0')}:00` : 
                            d.slotTime.toString());
            return timeStr === targetTime;
          });
          const demandCount = quarterData ? (quarterData.requiredUnits || 0) : 0;
          demandByTime.set(`${h}_${m}`, demandCount);
        }
      }

      // レジ番号の行を作成（レジ1からmaxDemandまで）
      for (let registerNo = 1; registerNo <= maxDemand; registerNo++) {
        const registerRowHeader = document.createElement('div');
        registerRowHeader.className = 'grid-row-header';
        registerRowHeader.textContent = `レジ ${registerNo}`;
        workModelGrid.appendChild(registerRowHeader);

        for (let h = 0; h < 24; h++) {
          for (let m = 0; m < 60; m += 15) {
            const demandCount = demandByTime.get(`${h}_${m}`) || 0;
            
            // この時間帯にこのレジ番号が必要な場合のみセルを作成
            if (registerNo <= demandCount) {
              const cell = document.createElement('div');
              cell.className = 'grid-cell work-model-cell register-needed';
              workModelGrid.appendChild(cell);
            } else {
              // 不要な場合は空のdivを作成（グリッドレイアウト維持のため）
              const emptyCell = document.createElement('div');
              emptyCell.className = 'grid-cell work-model-cell-empty';
              workModelGrid.appendChild(emptyCell);
            }
          }
        }
      }
      
      // 作業モデル用のCSSグリッドを設定（15分間隔と同じ）
      workModelGrid.style.gridTemplateColumns = '120px repeat(96, 50px)';
    } else {
      workModelCard.style.display = 'none';
    }
  } catch (error) {
    console.error('作業モデルデータ取得エラー:', error);
    $('workModelCard').style.display = 'none';
  }
}
</script>
</div>
</body>
</html>