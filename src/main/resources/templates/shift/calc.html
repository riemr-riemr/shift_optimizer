<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <title>シフト最適化</title>
</head>
<body>
<div layout:fragment="content">
  <div class="content-header">
    <h1><i class="bi bi-calculator"></i> シフト最適化</h1>
    <p class="mb-0">OptaPlannerを使用してシフトの自動最適化を実行できます</p>
  </div>

<div class="row g-4">
  <!-- Control Panel -->
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-gear-fill"></i> 最適化コントロール</h5>
      </div>
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label fw-semibold">
              <i class="bi bi-calendar-month me-1"></i>対象月
            </label>
            <input type="month" id="month" class="form-control form-control-lg">
          </div>
          <div class="col-md-2">
            <button id="btnCalc" class="btn btn-primary btn-lg">
              <i class="bi bi-play-fill me-2"></i>最適化開始
            </button>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">
              <i class="bi bi-calendar-day me-1"></i>表示日
            </label>
            <input type="date" id="date" class="form-control form-control-lg">
          </div>
          <div class="col-md-4">
            <div class="btn-group" role="group">
              <button id="btnPrevDay" class="btn btn-outline-secondary">
                <i class="bi bi-chevron-left"></i> 前日
              </button>
              <button id="btnSearch" class="btn btn-success">
                <i class="bi bi-search"></i> 検索
              </button>
              <button id="btnNextDay" class="btn btn-outline-secondary">
                翌日 <i class="bi bi-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Progress Section -->
<div class="row g-4 mt-2">
  <div class="col-12">
    <div class="card" id="progressCard" style="display:none;">
      <div class="card-header">
        <i class="bi bi-hourglass-split me-2"></i>最適化進捗
      </div>
      <div class="card-body">
        <div id="progressArea" class="progress" style="height:28px;">
          <div id="bar" class="progress-bar progress-bar-striped progress-bar-animated" 
               style="width:0%; transition: width 0.3s ease; font-weight: 600;">0%</div>
        </div>
        <div class="mt-2 text-muted" id="progressMessage">
          <small><i class="bi bi-info-circle me-1"></i>最適化アルゴリズムが実行中です...</small>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Results Section -->
<div class="row g-4 mt-2">
  <div class="col-12">
    <div class="card" id="resultsCard" style="display:none;">
      <div class="card-header">
        <i class="bi bi-table me-2"></i>シフト割り当て結果
      </div>
      <div class="card-body p-0">
        <div class="table-responsive" style="max-height: 600px; overflow-x: auto; overflow-y: auto;">
          <div id="shiftGrid" class="shift-grid-container"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .shift-grid-container {
    display: grid;
    grid-template-columns: 120px repeat(96, 50px);
    gap: 1px;
    border: 1px solid #dee2e6;
    min-width: 4920px; /* 120px + (96 * 50px) + gaps */
    width: max-content;
  }
  
  .grid-header, .grid-cell {
    padding: 8px 4px;
    text-align: center;
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    white-space: nowrap;
    font-size: 0.75rem;
  }
  
  .grid-header.time-slot {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 1;
  }
  
  .grid-row-header {
    font-weight: 700;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    position: sticky;
    left: 0;
    z-index: 1;
  }
  
  .grid-cell.assigned {
    font-weight: 600;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
  }
  
  .grid-cell.assigned.color-0 { background: linear-gradient(135deg, #28a745, #20c997); }
  .grid-cell.assigned.color-1 { background: linear-gradient(135deg, #007bff, #6610f2); }
  .grid-cell.assigned.color-2 { background: linear-gradient(135deg, #ffc107, #fd7e14); }
  .grid-cell.assigned.color-3 { background: linear-gradient(135deg, #dc3545, #e83e8c); }
  .grid-cell.assigned.color-4 { background: linear-gradient(135deg, #6c757d, #495057); }
</style>

<script>
const $=id=>document.getElementById(id);

// Function to generate a consistent color based on employee name
function getEmployeeColorClass(employeeName) {
  let hash = 0;
  for (let i = 0; i < employeeName.length; i++) {
    hash = employeeName.charCodeAt(i) + ((hash << 5) - hash);
  }
  return `color-${Math.abs(hash) % 5}`; // Use 5 distinct colors
}

$('btnCalc').onclick=async()=>{
  const m=$('month').value;
  if(!m){alert('月を選択してください');return;}
  
  try {
    // プログレスカードを表示して初期化
    $('progressCard').style.display='block';
    $('resultsCard').style.display='none';
    $('bar').style.width='0%';
    $('bar').textContent='0%';
    $('bar').className='progress-bar progress-bar-striped progress-bar-animated bg-primary'; // クラスをリセット
    
    const ticket=await fetch('/shift/api/calc/start',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({month:m})}).then(r=>r.json());
    console.log('Calculation started:', ticket); // デバッグログ
    
    if (ticket.problemId) {
      tick(ticket.problemId, m);
    } else {
      throw new Error('Problem ID not received');
    }
  } catch (error) {
    console.error('Calculation start error:', error);
    $('bar').classList.add('bg-danger');
    $('bar').textContent = '開始エラー';
  }
};

$('btnSearch').onclick=async()=>{
  const d=$('date').value;
  if(!d){alert('日付を選択してください');return;}
  loadResult(d);
};

$('btnPrevDay').onclick=()=>{
  const currentDate = $('date').value;
  if(!currentDate){
    alert('日付を選択してください');
    return;
  }
  const date = new Date(currentDate);
  date.setDate(date.getDate() - 1);
  const newDate = date.toISOString().split('T')[0];
  $('date').value = newDate;
  loadResult(newDate);
};

$('btnNextDay').onclick=()=>{
  const currentDate = $('date').value;
  if(!currentDate){
    alert('日付を選択してください');
    return;
  }
  const date = new Date(currentDate);
  date.setDate(date.getDate() + 1);
  const newDate = date.toISOString().split('T')[0];
  $('date').value = newDate;
  loadResult(newDate);
};

async function tick(id, month){
  try {
    const st = await fetch(`/shift/api/calc/status/${id}`).then(r => r.json());
    console.log('Status response:', st); // デバッグログ
    
    // プログレス値の正規化（0-100の範囲に制限）
    const progress = Math.max(0, Math.min(100, st.progress || 0));
    $('bar').style.width = progress + '%';
    $('bar').textContent = progress + '%';
    
    // 計算中の場合は継続、完了・エラー・未実行の場合は終了
    if (st.status === 'SOLVING' || st.status === 'SOLVING_ACTIVE') {
      setTimeout(() => tick(id, month), 1000);
    } else {
      // 完了時の処理
      if (st.status === 'NOT_SOLVING') {
        $('bar').classList.add('bg-success');
        $('bar').textContent = '完了 (100%)';
        $('bar').style.width = '100%';
        
        // プログレスメッセージを更新
        $('progressMessage').innerHTML = '<small><i class="bi bi-check-circle-fill me-1 text-success"></i>最適化完了しました！</small>';
        
        // プログレスカードを隠す
        setTimeout(() => {
          $('progressCard').style.display = 'none';
        }, 3000);
        
        // 計算完了後、当月の最初の日を表示
        const [year, monthNum] = month.split('-').map(Number);
        const firstDayOfMonth = `${year}-${String(monthNum).padStart(2, '0')}-01`;
        loadResult(firstDayOfMonth);
      } else {
        // エラー状態の処理
        $('bar').classList.add('bg-danger');
        $('bar').textContent = 'エラー';
        console.error('Solver error status:', st.status);
      }
    }
  } catch (error) {
    console.error('Progress polling error:', error);
    $('bar').classList.add('bg-danger');
    $('bar').textContent = '通信エラー';
  }
}

async function loadResult(dateString){
  const data=await fetch(`/shift/api/calc/assignments/daily/${dateString}`).then(r=>r.json());
  const shiftGrid = $('shiftGrid');
  const resultsCard = $('resultsCard');
  
  shiftGrid.innerHTML = ''; // Clear previous content
  
  if (data && data.length > 0) {
    resultsCard.style.display = 'block';
  } else {
    resultsCard.style.display = 'none';
    return;
  }

  // Determine unique registers
  const registers = [...new Set(data.map(a => a.registerNo))].sort((a, b) => a - b);

  // Create time headers (15-minute intervals)
  const timeHeaderRow = document.createElement('div');
  timeHeaderRow.className = 'grid-row';
  timeHeaderRow.style.gridColumn = '1 / -1'; // Span all columns
  timeHeaderRow.style.display = 'contents'; // Allow children to be grid items

  const emptyHeader = document.createElement('div');
  emptyHeader.className = 'grid-header';
  timeHeaderRow.appendChild(emptyHeader); // Empty cell for register column

  for (let h = 0; h < 24; h++) {
    for (let m = 0; m < 60; m += 15) {
      const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
      const timeHeader = document.createElement('div');
      timeHeader.className = 'grid-header time-slot';
      timeHeader.textContent = time;
      timeHeaderRow.appendChild(timeHeader);
    }
  }
  shiftGrid.appendChild(timeHeaderRow);

  // Create grid rows for each register
  registers.forEach(registerNo => {
    const registerRowHeader = document.createElement('div');
    registerRowHeader.className = 'grid-row-header';
    registerRowHeader.textContent = `レジ ${registerNo}`;
    shiftGrid.appendChild(registerRowHeader);

    for (let h = 0; h < 24; h++) {
      for (let m = 0; m < 60; m += 15) {
        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        cell.dataset.register = registerNo;
        cell.dataset.time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        shiftGrid.appendChild(cell);
      }
    }
  });

  // Populate grid with assignments
  data.forEach(assignment => {
    const start = new Date(assignment.startAt);
    const end = new Date(assignment.endAt);
    const employeeAbbr = assignment.employeeName.substring(0, 2); // First two characters
    const colorClass = getEmployeeColorClass(assignment.employeeName);

    // Iterate through 15-minute intervals for the assignment
    let currentTime = new Date(start);
    while (currentTime < end) {
      const hour = currentTime.getHours();
      const minute = currentTime.getMinutes();
      const targetTime = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;

      const cell = shiftGrid.querySelector(`.grid-cell[data-register="${assignment.registerNo}"][data-time="${targetTime}"]`);
      if (cell) {
        cell.classList.add('assigned', colorClass);
        cell.textContent = employeeAbbr;
      }
      currentTime.setMinutes(currentTime.getMinutes() + 15);
    }
  });
}
</script>
</div>
</body>
</html>